<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.6, user-scalable=yes" />
    <title>Invoice Viewer | SwiftInvoice</title>
    <link rel="shortcut icon" href="https://stack-base.github.io/media/brand/swiftinvoice/swiftinvoice-icon.png" type="image/x-icon">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- REUSED STYLES --- */
        *, *::before, *::after { box-sizing: border-box; }
        :root {
            --bg-body: #f3f4f6;
            --bg-paper: #ffffff;
            --text-main: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --primary: #0d9488;
            --primary-hover: #0f766e;
        }
        body { 
            font-family: 'Inter', Arial, Helvetica, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Viewer Specific Header */
        .viewer-header {
            background-color: var(--bg-paper);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .brand { font-family: 'Ubuntu', sans-serif; font-weight: 700; color: var(--primary); font-size: 1.25rem; }
        .actions { display: flex; gap: 0.75rem; }

        /* Buttons */
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; 
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: white; border-color: var(--border-color); color: var(--text-main); }
        .btn-secondary:hover { background-color: var(--bg-body); }
        .btn svg { width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; }

        /* Invoice Container */
        .main-content { 
            flex: 1; 
            padding: 2rem; 
            display: flex; 
            justify-content: center; 
            overflow: auto; /* Allow scrolling if paper is wider than screen */
        }
        
        .paper { 
            background: white; 
            /* Fixed A4 Width Logic */
            width: 210mm; 
            min-width: 210mm; 
            min-height: 297mm; 
            padding: 40px; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
            display: flex; 
            flex-direction: column;
            margin: 0 auto; /* Center */
        }

        /* Invoice Typography */
        h1.title { font-size: 32px; margin: 0 0 16px 0; font-weight: 700; text-transform: uppercase; color: #111827; }
        h2 { font-size: 14px; margin: 0 0 8px 0; font-weight: 600; color: #111827; }
        .meta-table { font-size: 12px; border-collapse: collapse; margin-bottom: 24px; }
        .meta-table td { padding: 4px 0; vertical-align: top; }
        .meta-table td.label { width: 120px; font-weight: 600; color: #4b5563; }
        .address { font-size: 12px; white-space: pre-wrap; line-height: 1.6; color: #4b5563; }
        
        /* Layout */
        .invoice-header-row { display: flex; justify-content: space-between; margin-bottom: 24px; border-bottom: 2px solid #f3f4f6; padding-bottom: 20px; }
        
        .header-right { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
        }

        .party-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 32px; }
        .party { width: 48%; }
        .invoice-logo { max-height: 80px; max-width: 150px; object-fit: contain; }

        /* QR Code Style */
        #qr-code { 
            margin-top: 10px; 
            padding: 4px; 
            background: white; 
            border: 1px solid #e5e7eb; 
            border-radius: 4px; 
            display: inline-block; 
        }
        #qr-code img, #qr-code canvas { 
            display: block;
            max-width: 180px; 
            height: auto;
        }

        /* Items Table */
        #items { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 20px; }
        #items th { background: #f9fafb; padding: 12px 8px; font-weight: 600; color: #4b5563; text-transform: uppercase; }
        #items td { padding: 12px 8px; border-bottom: 1px solid #f3f4f6; vertical-align: top; color: #111827; }
        #items th:first-child, #items td:first-child { width: 40px; }
        
        .desc { white-space: pre-wrap; line-height: 1.6; }
        .item-meta { font-size: 11px; color: #6b7280; margin-top: 4px; }

        #items td:nth-child(1), #items th:nth-child(1) { text-align: center; }
        #items td:nth-child(2), #items th:nth-child(2) { text-align: left; }
        #items td:nth-child(3), #items th:nth-child(3) { text-align: left; }
        #items td:nth-child(4), #items th:nth-child(4) { text-align: center; }
        #items td:nth-child(5), #items th:nth-child(5) { text-align: right; }
        #items td:nth-child(6), #items th:nth-child(6) { text-align: right; }
        #items td:nth-child(7), #items th:nth-child(7) { text-align: right; }
        #items td:nth-child(8), #items th:nth-child(8) { text-align: right; }
        #items th:last-child, #items td:last-child { text-align: right; }

        /* Totals */
        .totals { display: flex; justify-content: flex-end; margin-top: 32px; }
        .totals-box { width: 300px; font-size: 12px; }
        .totals-table { width: 100%; border-collapse: collapse; }
        .totals-table td { padding: 8px 0; }
        .totals-table td.value { text-align: right; font-weight: 700; color: #111827; }
        .totals-table tr:last-child { border-top: 2px solid #e5e7eb; font-size: 14px; }
        .totals-table tr:last-child td { padding-top: 12px; }

        /* Print Styles */
        @media print {
            .viewer-header, .hide-on-print { display: none !important; }
            body, .main-content { background: white; margin: 0; padding: 0; }
            .paper { box-shadow: none; padding: 0; width: 100%; min-width: 0; }
            #qr-code { border: none; }
            #qr-code img, #qr-code canvas { max-width: none; width: 180px; }
        }

        .loading-overlay {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        .error-msg { color: #dc2626; margin-top: 1rem; text-align: center; max-width: 400px; }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-overlay">
        <svg class="animate-spin" style="width: 3rem; height: 3rem; color: var(--primary);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" style="opacity: 0.25;"></circle>
            <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" fill="currentColor" style="opacity: 0.75;"></path>
        </svg>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading Invoice...</p>
        <p id="error-message" class="error-msg hidden"></p>
    </div>

    <header class="viewer-header">
        <div class="brand">SwiftInvoice Viewer</div>
        <div class="actions">
            <button id="print-btn" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.198-.54-1.214-1.201L6.054 18m11.606 0c.54 0 1.077-.077 1.602-.224 1.12-.312 1.956-1.348 1.956-2.54V9.67c0-.693-.559-1.252-1.252-1.252H4.945c-.693 0-1.252.559-1.252 1.252v5.536c0 1.192.836 2.228 1.956 2.54.525.148 1.062.225 1.602.225M17.66 18h-11.606" />
                </svg>
                Print
            </button>
            <button id="download-btn" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                Download PDF
            </button>
        </div>
    </header>

    <main class="main-content">
        <div id="invoice-paper" class="paper">
            <div class="invoice-header-row">
                <div class="header-left">
                    <h1 class="title">Invoice</h1>
                    <table class="meta-table">
                        <tr><td class="label">Invoice Nr</td><td id="inv-num">...</td></tr>
                        <tr><td class="label">Invoice Date</td><td id="inv-date">...</td></tr>
                        <tr><td class="label">Invoice Time</td><td id="inv-time">...</td></tr>
                    </table>
                </div>
                <div class="header-right">
                    <img id="inv-logo" src="" alt="Logo" class="invoice-logo hidden" />
                    <div id="qr-code"></div>
                </div>
            </div>

            <div class="party-row">
                <div class="party">
                    <h2>Seller</h2>
                    <div id="inv-seller" class="address">...</div>
                </div>
                <div class="party">
                    <h2>Buyer</h2>
                    <div id="inv-buyer" class="address">...</div>
                </div>
            </div>

            <table id="items">
                <thead>
                    <tr>
                        <th>LINE NR</th>
                        <th>PRODUCT CODE</th>
                        <th>DESCRIPTION</th>
                        <th>QTY</th>
                        <th>PRICE EXCL VAT</th>
                        <th>VAT RATE</th>
                        <th>VAT AMOUNT</th>
                        <th>Price incl VAT</th>
                    </tr>
                </thead>
                <tbody id="items-body">
                    </tbody>
            </table>

            <div class="totals">
                <div class="totals-box">
                    <div id="inv-currency" style="text-align: right; margin-bottom: 8px; color: #6b7280; font-size: 11px;">AED</div>
                    <table class="totals-table">
                        <tbody id="charges-body"></tbody>
                        <tbody>
                            <tr>
                                <td>Subtotal</td>
                                <td id="inv-subtotal" class="value">0.00</td>
                            </tr>
                            <tr>
                                <td>VAT Total</td>
                                <td id="inv-vat" class="value">0.00</td>
                            </tr>
                            <tr>
                                <td>Grand Total</td>
                                <td id="inv-total" class="value">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 12px;">
                SwiftInvoice | <strong>StackBase</strong>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingScreen = document.getElementById('loading-screen');
            const errorMsg = document.getElementById('error-message');
            
            // 1. Get URL Parameter
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('view');

            if (!encodedData) {
                errorMsg.textContent = "No invoice data found in URL.";
                errorMsg.classList.remove('hidden');
                return;
            }

            try {
                // 2. Decode Data (LZ-String)
                const jsonString = LZString.decompressFromEncodedURIComponent(encodedData);
                
                if (!jsonString) {
                    throw new Error("Failed to decompress data.");
                }

                const data = JSON.parse(jsonString);

                // 3. Populate DOM
                document.getElementById('inv-num').textContent = data.n || '';
                document.getElementById('inv-date').textContent = data.d || '';
                document.getElementById('inv-time').textContent = data.t || '';
                
                // FIX: Use innerHTML to render HTML tags (like <br> or <div>) correctly
                document.getElementById('inv-seller').innerHTML = data.s || '';
                document.getElementById('inv-buyer').innerHTML = data.b || '';

                // Logo
                const logoImg = document.getElementById('inv-logo');
                if (data.l) {
                    logoImg.src = data.l;
                    logoImg.classList.remove('hidden');
                }

                // Currency Label
                if (data.r) {
                     document.getElementById('inv-currency').textContent = data.c || data.r; 
                }

                // Render Items
                const tbody = document.getElementById('items-body');
                tbody.innerHTML = '';
                
                if (data.i && Array.isArray(data.i)) {
                    data.i.forEach(item => {
                        const tr = document.createElement('tr');
                        
                        let metaHtml = '';
                        if(item.sn) metaHtml += `<div>SN: ${item.sn}</div>`;
                        if(item.st) metaHtml += `<div>Style: ${item.st}</div>`;

                        tr.innerHTML = `
                            <td data-label="#">${item.l}</td>
                            <td data-label="Code">${item.c}</td>
                            <td data-label="Description">
                                <div>${item.d}</div>
                                <div class="item-meta">${metaHtml}</div>
                            </td>
                            <td data-label="Qty">${item.q}</td>
                            <td data-label="Price">${item.e}</td>
                            <td data-label="VAT%">${item.r}</td>
                            <td data-label="VAT">${item.v}</td>
                            <td data-label="Total" style="font-weight:600;">${item.t}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Render Charges
                const chargesBody = document.getElementById('charges-body');
                chargesBody.innerHTML = '';
                if (data.ch && Array.isArray(data.ch)) {
                    data.ch.forEach(charge => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${charge.n}</td><td class="value">${charge.v}</td>`;
                        chargesBody.appendChild(tr);
                    });
                }

                // Totals
                document.getElementById('inv-subtotal').textContent = data.st || '0.00';
                document.getElementById('inv-vat').textContent = data.vt || '0.00';
                document.getElementById('inv-total').textContent = data.gt || '0.00';

                // --- GENERATE QR CODE ---
                const qrContainer = document.getElementById('qr-code');
                if (QRCode) {
                    new QRCode(qrContainer, {
                        text: window.location.href,
                        width: 256,  
                        height: 256,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L
                    });
                }

                // Hide Loading
                loadingScreen.classList.add('hidden');

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "Invalid or corrupted invoice link.";
                errorMsg.classList.remove('hidden');
            }
        });

        // --- Print Function ---
        document.getElementById('print-btn').addEventListener('click', () => {
            window.print();
        });

        // --- Download PDF Function ---
        document.getElementById('download-btn').addEventListener('click', async () => {
            const btn = document.getElementById('download-btn');
            const paper = document.getElementById('invoice-paper');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = 'Generating...';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfW = pdf.internal.pageSize.getWidth();
                const pdfH = pdf.internal.pageSize.getHeight();
                
                const renderContainer = document.createElement('div');
                renderContainer.style.width = '800px'; 
                renderContainer.style.position = 'absolute';
                renderContainer.style.left = '-9999px';
                
                const clonedPaper = paper.cloneNode(true);
                const qr = clonedPaper.querySelector('#qr-code');
                if(qr) { qr.style.border = 'none'; }

                renderContainer.appendChild(clonedPaper);
                document.body.appendChild(renderContainer);

                const canvas = await html2canvas(renderContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    width: renderContainer.scrollWidth,
                    height: renderContainer.scrollHeight
                });

                document.body.removeChild(renderContainer);

                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfHeight = (imgProps.height * pdfW) / imgProps.width;
                
                let heightLeft = pdfHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, pdfW, pdfHeight);
                heightLeft -= pdfH;

                while (heightLeft >= 0) {
                    position = heightLeft - pdfHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfW, pdfHeight);
                    heightLeft -= pdfH;
                }

                const invNum = document.getElementById('inv-num').textContent || 'Invoice';
                pdf.save(`${invNum}.pdf`);

            } catch (e) {
                console.error(e);
                alert('Error generating PDF');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>